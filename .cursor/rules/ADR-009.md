# ADR-009: Timeouts, Offline Mode, and Long-Running Process Discipline

Status: Proposed
Date: 2025-09-01

Context
- Some operations can appear to “hang” in Warp when external calls have no explicit timeouts or when long-running loops are invoked without clear bounds.
- Areas observed:
  - Long-running loops: CLI watch mode (fresh run --watch), adaptive monitor, SSE web monitor, MCP discovery background loops
  - External calls without explicit timeouts: GitHub REST/CLI, git commands, Firestore streams/queries, occasional OpenAI calls
  - Subprocess calls that may prompt interactively (gh, git) and stall
- This ADR standardizes our approach to prevent unintended hangs, improve developer UX, and keep behaviors obvious and cancellable.

Decision
1) Default timeout policy
- All external I/O (HTTP requests, OpenAI calls, git/gh subprocess, Firestore ops where applicable) must specify a timeout (default: 30 seconds). A shared constant (e.g., TIMEOUT_SECONDS=30) will be introduced for consistency and tuning.

2) Offline/safe mode
- Introduce and respect an offline flag in both environment and CLI:
  - Env: FRESH_OFFLINE=1 (truthy values: 1/true/yes)
  - CLI: fresh ... --offline
- When offline, networked operations are skipped with a clear, actionable message, returning safe placeholders where necessary (e.g., ADR reference for later execution).

3) Long-running process discipline
- Watch/monitor flows (fresh run --watch, adaptive monitor, web SSE) are explicitly documented as long-running and cancellable via Ctrl-C.
- Add optional bounds where helpful (e.g., --stop-after <seconds|iterations> for watch mode) to support automated verification and prevent unexpected persistence in development sessions.

4) Subprocess safety
- All subprocess calls (git/gh/etc.):
  - Use timeout=TIMEOUT_SECONDS and check=True where appropriate
  - Use stdin=subprocess.DEVNULL to avoid interactive prompts in CI/agents
  - Fail fast with an actionable error if gh is not authenticated or remote is unreachable

5) Background task lifecycle
- MCP discovery and similar background tasks must be cancellable and shut down cleanly on exit (stop_discovery()). Add an async context manager or atexit hook for cleanup when started by tools.

Implementation Plan (Checklist)
- [ ] Centralize TIMEOUT_SECONDS (e.g., ai/settings.py or ai/utils/constants.py)
- [ ] MotherAgent (ai/agents/mother.py): ensure OpenAI calls consistently use timeout; respect offline mode
- [ ] Repo scanner (ai/loop/repo_scanner.py): add timeout to git diff calls
- [ ] GitHub integration (ai/integration/github.py):
  - [ ] Add timeout to requests.post
  - [ ] Add timeout + stdin=DEVNULL to git/gh subprocess.run calls
  - [ ] Preflight gh auth and return a clear message if not authenticated
  - [ ] Respect offline mode (skip PR creation/push)
- [ ] CLI (ai/cli/fresh.py):
  - [ ] Add --offline and propagate
  - [ ] Add --stop-after for watch mode (time or cycles)
- [ ] MCP discovery (ai/integration/mcp_discovery.py):
  - [ ] Ensure start/stop symmetry; context-managed usage in tools
  - [ ] Tests to verify tasks are cancelled on shutdown
- [ ] Tests (tests/…):
  - [ ] Assert timeout args are passed to requests/subprocess
  - [ ] Offline mode bypasses network with clear messaging
  - [ ] Watch mode honors --stop-after and Ctrl-C
- [ ] Docs:
  - [ ] WARP.md: Long-running commands (how to exit), Offline mode
  - [ ] TROUBLESHOOTING.md: “Hangs & timeouts” playbook

Consequences
- Pros: Fewer perceived hangs; clearer failure modes; safer subprocess behavior; better developer ergonomics in Warp.
- Cons: Slightly more boilerplate (timeouts/env checks); potential for false timeouts on slow networks (mitigated by configurable default).

References (modules and docs to update)
- CLI: ai/cli/fresh.py
- Agents: ai/agents/mother.py
- Repo scanner: ai/loop/repo_scanner.py
- GitHub: ai/integration/github.py
- MCP discovery: ai/integration/mcp_discovery.py
- Monitors: scripts/watch-agents-adaptive.py, ai/monitor/web.py
- Docs: WARP.md, docs/TROUBLESHOOTING.md, docs/INDEX.md (cross-links)
- Tests: tests/ (new suites for timeouts/offline/loops)

Notes
- Aligns with repository rules (TDD-first and ADR discipline) and Warp usage preferences.
- This ADR is intentionally incremental; functional changes should reference ADR-009 in PRs and commit messages.
