# ADR-004: Persistent Agent Memory (Firestore-backed, staging-only)
Status: Proposed
Date: 2025-08-31

## Context
- We want the mother-agent and its swarm to learn from past interactions in this codebase, improving over time.
- ADR-002 mandates staging-only access for development and testing; ADR-003 adopts Firebase Firestore for the modern stack with staging-only usage.
- We need a simple, reliable MemoryStore abstraction with an in-memory fallback for local runs, and a Firestore-backed implementation for shared persistence across sessions and CI (staging only).

## Decision
- Introduce a `MemoryStore` interface with two implementations:
  1) `InMemoryMemoryStore` (default): used when credentials are missing; zero external deps; ephemeral.
  2) `FirestoreMemoryStore` (optional): used when FIREBASE_* env vars are present and `google-cloud-firestore` is installed.
- Provide Agency Swarm tools:
  - `WriteMemory(content, tags[])` → append memory event to store and return id.
  - `ReadMemoryContext(limit, tags[])` → fetch most recent items (desc), returning a compact text context for prompts.
- Wire the agency to initialize a MemoryStore at startup and make the tools available to agents that need them.
- Keep production access out-of-scope for dev/test; follow ADR-002 (staging only). Secrets remain in env; no secrets in VCS.

## Alternatives
- Local file-based store (JSON/SQLite): simple, but worse for concurrent runs and not cloud-backed.
- Vector DB (e.g., FAISS/Pinecone) now: overkill for initial milestone; can be added behind the same interface later.

## Consequences
- Positive:
  - Consistent abstraction for persistence with a drop-in Firestore backend.
  - Safe defaults: in-memory fallback; staging-only cloud usage.
- Negative:
  - Additional dependency (`google-cloud-firestore`) for the Firestore path.
- Security/Privacy impact:
  - PII minimization: store only necessary text/context; avoid secrets.
  - Access via env-based credentials; never in code.
- Migration plan:
  - Start with in-memory; enable Firestore by setting env vars.
  - If moving to a different backend, keep the `MemoryStore` interface stable.

## Verification
- Tests added/updated:
  - Unit tests for `InMemoryMemoryStore` CRUD and ordering.
  - Tool invocation tests for Write/Read tools.
  - Agency integration test to confirm context injection path (skipped if OPENAI_API_KEY is dummy and/or agency_swarm missing).
- Metrics/alerts:
  - N/A for now; consider counters for write/read and error logs in future.
